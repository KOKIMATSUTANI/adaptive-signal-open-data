# docker/Dockerfile.backup
# Google Drive backup service (short-lived task)
# Single execution per container instance - designed for scheduled runs
ARG BASE_IMAGE=tram-base:latest
ARG APP_UID=1000
ARG APP_GID=1000
FROM ${BASE_IMAGE}
WORKDIR /app

# Add dependencies for backup (install as root user)
COPY requirements/ingest.txt /tmp/requirements-backup.txt
RUN pip install -r /tmp/requirements-backup.txt \
    && rm /tmp/requirements-backup.txt

# Install rclone for Google Drive backup
RUN curl https://rclone.org/install.sh | bash

# Copy only necessary code for backup
COPY src/gtfs_pipeline/ ./src/gtfs_pipeline/
COPY configs/ ./configs/
COPY scripts/ ./scripts/

# Create appuser config directory and set proper permissions
# NOTE: Do not use chmod 777 or 666.
# Use proper ownership (chown) and safe permissions instead (chmod 755).
RUN mkdir -p /home/appuser/.config/rclone \
    && chown -R ${APP_UID}:${APP_GID} /app /home/appuser \
    && chmod +x /app/scripts/backup_to_google_drive.sh \
    && chmod 755 /home/appuser/.config \
    && chmod 755 /home/appuser/.config/rclone

# Data volume (assumes external mount)
VOLUME ["/app/data"]

# Switch user
USER appuser

# Short-lived task execution
# Single backup execution per container instance
ENTRYPOINT ["/app/scripts/backup_to_google_drive.sh"]
CMD ["--once"]

# Usage examples:
# Single backup execution (short-lived task):
# docker run --rm -v /host/data:/app/data -v /host/configs:/app/configs tram-backup:latest --once
# Backup with specific interval:
# docker run --rm -v /host/data:/app/data -v /host/configs:/app/configs -e BACKUP_INTERVAL=300 tram-backup:latest --once
